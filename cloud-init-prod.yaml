#cloud-config

# Production cloud-init configuration
# More security-focused and optimized for production workloads

package_update: true
package_upgrade: true

# Production user configuration
users:
  - name: ubuntu
    groups: [sudo]
    shell: /bin/bash
    sudo: "ALL=(ALL) NOPASSWD:ALL"
    ssh_authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAr... # Production SSH key

# Production packages - minimal and security-focused
packages:
  - curl
  - wget
  - git
  - htop
  - gnupg
  - vim
  - net-tools
  - ca-certificates
  - software-properties-common
  - unattended-upgrades
  - fail2ban
  - ufw
  - chrony  # Time synchronization
  - auditd  # Security auditing

# Production-specific commands
runcmd:
  - echo "Production server initialization started" > /var/log/server-init.log
  
  # Configure UFW firewall
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow 2222/tcp  # Custom SSH port
  - ufw allow 443/tcp   # HTTPS
  - ufw allow 8080/tcp  # Application port
  - echo "y" | ufw enable
  
  # Configure fail2ban for SSH protection
  - systemctl enable fail2ban
  - systemctl start fail2ban
  
  # Enable and configure unattended upgrades for security
  - echo 'Unattended-Upgrade::Automatic-Reboot "false";' >> /etc/apt/apt.conf.d/50unattended-upgrades
  - echo 'Unattended-Upgrade::Remove-Unused-Dependencies "true";' >> /etc/apt/apt.conf.d/50unattended-upgrades
  - systemctl enable unattended-upgrades
  
  # Configure time synchronization
  - systemctl enable chrony
  - systemctl start chrony
  
  # Enable audit logging
  - systemctl enable auditd
  - systemctl start auditd
  
  # SSH hardening
  - sed -i 's/#Port 22/Port 2222/' /etc/ssh/sshd_config
  - sed -i 's/#PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config
  - sed -i 's/#MaxAuthTries 6/MaxAuthTries 3/' /etc/ssh/sshd_config
  - systemctl restart sshd
  
  # Clean up
  - apt-get autoremove -y
  - apt-get clean
  
  - echo "Production server initialization complete" >> /var/log/server-init.log

# Disable password authentication (production security)
ssh_pwauth: false

# Set timezone
timezone: UTC

# Configure automatic security updates only
apt:
  sources:
    security:
      source: "deb http://security.ubuntu.com/ubuntu jammy-security main restricted universe multiverse"

# Production logging - more detailed
output: 
  all: ">> /var/log/cloud-init-output.log"
  
# Write additional files for production monitoring
write_files:
  - path: /etc/security-baseline.txt
    content: |
      # Security Baseline Applied
      - UFW firewall enabled
      - Fail2ban configured
      - SSH hardened (port 2222, no root login, max 3 auth tries)
      - Automatic security updates enabled
      - Audit logging enabled
      - Time synchronization configured
    permissions: '0644'
    
  - path: /etc/motd
    content: |
      ========================================
      WARNING: This is a production system
      All activity is monitored and logged
      Unauthorized access is prohibited
      ========================================
    permissions: '0644'

# No automatic reboot in production - manual control
# Administrators should schedule maintenance windows